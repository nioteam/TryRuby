(function($){$.fn.console=function(config){var keyCodes={left:37,right:39,up:38,down:40,back:8,del:46,end:35,start:36,ret:13};var cursor='<span class="jquery-console-cursor">&nbsp;</span>';var wbr=$.browser.opera?'&#8203;':'';var container=$(this);var inner=$('<div class="jquery-console-inner"></div>');var typer=$('<input class="jquery-console-typer" type="text">');var promptBox;var prompt;var promptLabel=config&&config.promptLabel?config.promptLabel:"> ";var column=0;var promptText='';var restoreText='';var history=[];var ringn=0;var cancelKeyPress=0;var extern={};(function(){container.append(inner);inner.append(typer);typer.css({position:'absolute',top:0,left:'-999px'});if(config.welcomeMessage)message(config.welcomeMessage,'jquery-console-welcome');newPromptBox();if(config.autofocus){inner.addClass('jquery-console-focus');typer.focus();setTimeout(function(){inner.addClass('jquery-console-focus');typer.focus()},100)}})();extern.reset=function(){var welcome=true;inner.parent().fadeOut(function(){inner.find('div').each(function(){if(!welcome)$(this).remove();welcome=false});newPromptBox();inner.parent().fadeIn(function(){inner.addClass('jquery-console-focus');typer.focus()})})};function newPromptBox(){column=0;promptText='';promptBox=$('<div class="jquery-console-prompt-box"></div>');var label=$('<span class="jquery-console-prompt-label"></span>');promptBox.append(label.text(promptLabel).show());prompt=$('<span class="jquery-console-prompt"></span>');promptBox.append(prompt);inner.append(promptBox);updatePromptDisplay()};container.click(function(){inner.addClass('jquery-console-focus');inner.removeClass('jquery-console-nofocus');typer.focus();scrollToBottom();return false});typer.blur(function(){inner.removeClass('jquery-console-focus');inner.addClass('jquery-console-nofocus')});typer.keydown(function(e){cancelKeyPress=0;var keyCode=e.keyCode;if(isControlCharacter(keyCode)){cancelKeyPress=keyCode;if(!typer.consoleControl(keyCode)){return false}}});typer.keypress(function(e){var keyCode=e.keyCode||e.which;if(cancelKeyPress!=keyCode&&keyCode>=32){if(cancelKeyPress)return false;typer.consoleInsert(keyCode)}if($.browser.webkit)return false});function isControlCharacter(keyCode){return((keyCode>=keyCodes.left&&keyCode<=keyCodes.down)||keyCode==keyCodes.back||keyCode==keyCodes.del||keyCode==keyCodes.end||keyCode==keyCodes.start||keyCode==keyCodes.ret)};typer.consoleControl=function(keyCode){switch(keyCode){case keyCodes.left:{moveColumn(-1);updatePromptDisplay();return false;break}case keyCodes.right:{moveColumn(1);updatePromptDisplay();return false;break}case keyCodes.back:{if(moveColumn(-1)){deleteCharAtPos();updatePromptDisplay()}return false;break}case keyCodes.del:{if(deleteCharAtPos())updatePromptDisplay();return false;break}case keyCodes.end:{if(moveColumn(promptText.length-column))updatePromptDisplay();return false;break}case keyCodes.start:{if(moveColumn(-column))updatePromptDisplay();return false;break}case keyCodes.ret:{commandTrigger();return false}case keyCodes.up:{rotateHistory(-1);return false}case keyCodes.down:{rotateHistory(1);return false}default:}};function rotateHistory(n){if(history.length==0)return;ringn+=n;if(ringn<0)ringn=history.length;else if(ringn>history.length)ringn=0;var prevText=promptText;if(ringn==0){promptText=restoreText}else{promptText=history[ringn-1]}if(config.historyPreserveColumn){if(promptText.length<column+1){column=promptText.length}else if(column==0){column=promptText.length}}else if(config.historyColumnAtEnd){column=promptText.length}else{column=0}updatePromptDisplay()};function addToHistory(line){history.push(line);restoreText=''};function deleteCharAtPos(){if(promptText!=''){promptText=promptText.substring(0,column)+promptText.substring(column+1);restoreText=promptText;return true}else return false};function commandTrigger(){var line=promptText;if(typeof config.commandValidate=='function'){var ret=config.commandValidate(line);if(ret==true||ret==false){if(ret){handleCommand()}}else{commandResult(ret,"jquery-console-message-error")}}else{handleCommand()}};function scrollToBottom(){inner.attr({scrollTop:inner.attr("scrollHeight")})};function handleCommand(){if(typeof config.commandHandle=='function'){var ret=config.commandHandle(promptText,function(msgs){commandResult(msgs)});if(typeof ret=='boolean'){if(ret){addToHistory(promptText);commandResult()}else{addToHistory(promptText);commandResult('Command failed.',"jquery-console-message-error")}}else if(typeof ret=="string"){addToHistory(promptText);commandResult(ret,"jquery-console-message-success")}else if(typeof ret=='undefined'){addToHistory(promptText)}else if(ret.length){addToHistory(promptText);commandResult(ret)}}};function commandResult(msg,className){column=-1;updatePromptDisplay();if(typeof msg=='string'){message(msg,className)}else{for(var x in msg){var ret=msg[x];message(ret.msg,ret.className)}}newPromptBox()};function message(msg,className){var mesg=$('<div class="jquery-console-message"></div>');if(className)mesg.addClass(className);mesg.filledText(msg).hide();inner.append(mesg);mesg.show()};typer.consoleInsert=function(keyCode){var char=String.fromCharCode(keyCode);var before=promptText.substring(0,column);var after=promptText.substring(column);promptText=before+char+after;moveColumn(1);restoreText=promptText;updatePromptDisplay()};function moveColumn(n){if(column+n>=0&&column+n<=promptText.length){column+=n;return true}else return false};function updatePromptDisplay(){var line=promptText;var html='';if(column>0&&line==''){html=cursor}else if(column==promptText.length){html=htmlEncode(line)+cursor}else{var before=line.substring(0,column);var current=line.substring(column,column+1);if(current){current='<span class="jquery-console-cursor">'+htmlEncode(current)+'</span>'}var after=line.substring(column+1);html=htmlEncode(before)+current+htmlEncode(after)}prompt.html(html);scrollToBottom()};function htmlEncode(text){return(text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/</g,'&lt;').replace(/ /g,'&nbsp;').replace(/([^<>&]{10})/g,'$1<wbr>&shy;'+wbr))};return extern};$.fn.filledText=function(txt){$(this).text(txt);$(this).html($(this).html().replace(/\n/g,'<br/>'));return this}})(jQuery);